---
title: "Introduction to rstac package"
author: "Rolf Simoes, Felipe Carvalho, and Gilberto Camara"
date: "2023-01-09"
output: 
  html_document:
    df_print: tibble
    theme:
      base_font:
        google: IBM Plex Serif
      code_font:
        google: IBM Plex Mono
classoption: x11names
fontsize: 10,5pt
indent: yes
link-citations: yes
vignette: >
  %\VignetteIndexEntry{Introduction to rstac package}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  cache = TRUE
)
```

```{r setup, echo=FALSE}
library(rstac)
library(tibble)
```

# About rstac

This document will introduce the concepts of the `rstac` package. `rstac` is an R client library for STAC that fully supports STAC API v1.0.0 and its earlier versions (>= v0.8.0).

The table shows the functions implemented by the `rstac` package according to 
the STAC API endpoints. For each endpoint, `rstac` has a specialized implementation. 


```{R endpoints, echo=FALSE}

data.frame(
  "**STAC** endpoints"   = c(
    "`/`", "`/stac`","`/collections`", "`/collections/{collectionId}`", 
    "`/collections/{collectionId}/items`", "`/collections/{collectionId}/items/{itemId}`", "`/search`", "`/stac/search`",
    "`/conformance`", "`/collections/{collectionId}/queryables`"
  ), "`rstac` functions" = c(
    "`stac()`", "`stac()`", "`collections()`", "`collections(collection_id)`",
    "`items()`", "`items(feature_id)`", "`stac_search()`", "`stac_search()`",
    "`conformance()`", "`queryables()`"
  ), "API version"      = c(
    ">= 0.9.0", "< 0.9.0", ">= 0.9.0", ">= 0.9.0", ">= 0.9.0", ">= 0.9.0",
    ">= 0.9.0", "< 0.9.0", ">= 0.9.0", ">= 1.0.0"
  ),
  check.names = FALSE
) %>% knitr::kable(format = "markdown")
```

The `rstac` package makes the requests explicitly. The `rstac` pipeline creates the endpoints with function concatenations and then requests them.

## Getting started

Let's start by installing the `rstac` package:

```{r installing, eval=FALSE}
install.packages("rstac")
```

## Creating queries

This tutorial use the STAC API made available by the [Brazil Data Cube (BDC)](http://www.brazildatacube.org/en/home-page-2/) project. BDC is a research, development, and technological innovation project of the National Institute for Space Research (INPE), Brazil.

Let's start by creating a query for the BDC catalog.

```{r queries-1}
s_obj <- stac("https://brazildatacube.dpi.inpe.br/stac/")
s_obj
```
The `RSTACQuery` object stores the metadata of the created query.
This metadata can be accessed as a list element during query creation.

```{r}
s_obj$base_url
```
Endpoints are constructed through function concatenations provided by `rstac`. Some examples are shown below:

```{r queries-2}
s_obj |> collections()
```

```{r queries-3}
s_obj |> collections("S2-16D-2")
```

```{r queries-4}
s_obj |> 
  collections("S2-16D-2") |>
  items()
```

```{r queries-5}
s_obj |> 
  collections("S2-16D-2") |> 
  items(feature_id = "S2-16D_V2_015011_20190117")
```

```{r queries-6}
s_obj |> 
  stac_search(collections = c("CB4_64_16D_STK", "S2-16D-2")) |>
  ext_query("bdc:tile" == "022024")
```

## Making requests

`rstac` package supports **GET** and **POST** HTTP 
methods. With future updates to the STAC specifications, it is intended to 
support other methods such as **PUT** and **DELETE**. 
In addition, it is possible to add more configuration options to the request, 
such as headers (`httr::add_headers()`) and cookies (`httr::set_cookies()`). 
These options are available in the `httr` package documentation in the [`config`](https://httr.r-lib.org/reference/config.html).

### HTTP GET: `get_request()`

```{r request-1}
s_obj |>
  collections(collection_id = "CB4_64_16D_STK-1") |>
  items() |>
  get_request() 
```

### HTTP POST: `post_request()`

```{r request-2}
s_obj |>
  stac_search(collections = c("CB4_64_16D_STK-1", "S2-16D-2"),
              datetime = "2021-01-01/2021-01-31",
              limit = 400) |>
  post_request()
```

Example of providing an additional argument to HTTP verb in a request:

```{r request-3}
s_obj |> 
  stac_search(collections = c("CB4_64_16D_STK-1", "S2-16D-2")) |>
  post_request(config = c(httr::add_headers("x-api-key" = "MY-KEY")))
```

## Visualization of the documents

Each `rstac` object is mapped according to the endpoints of the STAC spec. In this way, each object has a different view. The format for viewing objects is in **Markdown**.

#### `STACCatalog` object

```{r}
s_obj %>% get_request()
```

#### `STACCollection` object

```{r}
s_obj |>
  collections("S2-16D-2") |>
  get_request()
```

#### `STACItem` object

```{r}
s_obj |>
  collections("CB4_64_16D_STK-1") |>
  items(feature_id = "CB4_64_16D_STK_v001_021027_2020-07-11_2020-07-26") |>
  get_request()
```

#### `STACItemCollection` object

```{r}
s_obj |> 
  stac_search(collections = c("CB4_64_16D_STK", "S2-16D-2")) |>
  get_request()
```


Besides, the `rstac` package provides several auxiliary functions for `STACItem` and `STACItemCollection` objects. These auxiliary functions operate at the item or asset level. Functions dedicated to items have the prefix `items_`. Otherwise, asset-oriented functions have the prefix `assets_`

## Items functions

The `STACItemCollection` object have some facilitating functions to manipulate/extract information, for example:

- **`items_fields()`:** Lists fields names inside an item.
- **`item_filter()`:** Performs a filter by items according to expressions operating on the properties of a `STACItemCollection` object.
- **`item_fetch()`:** Performs the pagination of items.
- **`item_length()`:** Returns the number of items in an object.
- **`item_matched()`:** Returns the number of items matching the search criteria.
- **`item_assets()`:** Returns the assets name from `STACItemCollection` and `STACItem` objects.


It is interesting to verify the fields of items before filtering:

```{r}
s_obj |>
  stac_search(collections = "CB4_64_16D_STK-1",
              datetime = "2019-01-01/2019-12-31",
              limit = 100) |> 
  post_request() |>
  items_fields(field = "properties")
```

Let's filter items that have the percentage of clouds smaller than 10%:

```{r}
s_obj |>
  stac_search(collections = "CB4_64_16D_STK-1",
              datetime = "2019-01-01/2019-12-31",
              limit = 100) |> 
  post_request() |>
  items_filter(properties$`eo:cloud_cover` < 10)
```
Number of items returned in the query (in this case equal to the limit defined as parameter):

```{r}
s_obj |>
  stac_search(collections = "CB4_64_16D_STK-1",
              datetime = "2019-01-01/2019-12-31",
              limit = 100) |> 
  post_request() |>
  items_length()
```
Number of matched items in the query:

```{r}
s_obj |>
  stac_search(collections = "CB4_64_16D_STK-1",
              datetime = "2019-01-01/2019-12-31",
              limit = 100) |>
  post_request() |>
  items_matched()
```
Paginating all items that were matched in the query:

```{r}
items_fetched <- s_obj |>
  stac_search(collections = "CB4_64_16D_STK-1",
              datetime = "2019-01-01/2019-12-31",
              limit = 500) |>
  post_request() |>
  items_fetch()

items_fetched
```
Note that the 1127 has been recovered:

```{r}
items_length(items_fetched)
```

Listing the assets of the retrieved items:

```{r}
items_assets(items_fetched)
```


## Assets functions

- **`assets_download()`:**  Downloads the assets provided by the STAC API.
- **`assets_url()`:** Returns a character vector with each asset href. 
For the URL you can add the GDAL library drivers for the following schemes:
  - HTTP/HTTPS files;
  - S3 (AWS S3);
  - GS (Google Cloud Storage).
- **`assets_select()`:** Selects the assets of each item by its name.
- **`assets_rename()`:** Rename each asset using a named list or a function.

Listing the assets names of all items:

```{r}
s_obj |>
  stac_search(collections = "CB4_64_16D_STK-1",
              datetime = "2019-01-01/2019-12-31",
              limit = 10) |>
  post_request() |>
  items_assets()
```

Selecting assets that have names `"BAND14"` and `"NDVI"`

```{r}
selected_assets <- s_obj |>
  stac_search(collections = "CB4_64_16D_STK-1",
              datetime = "2019-01-01/2019-12-31",
              limit = 10) |>
  post_request() |>
  assets_select(asset_names = c("BAND14", "NDVI"))
```

```{r}
items_assets(selected_assets)
```

Listing asset urls from the selected bands:

```{r}
selected_assets |> assets_url()
```

Renaming assets using the pattern `<old-name> = <new-name>`

```{r}
renamed_assets <- selected_assets |> assets_rename(BAND14 = "B14")
renamed_assets
```

In the `assets` field of the output it can be seen that the asset's name has changed.
It is also possible to check the asset names using the `items_assets()` function.

```{r}
items_assets(renamed_assets)
```



## References

- [1] https://stacspec.org/
- [2] https://github.com/brazil-data-cube/rstac
